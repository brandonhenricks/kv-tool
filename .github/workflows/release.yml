name: Release

on:
  push:
    tags:
      - 'v*.*.*'

env:
  DOTNET_NOLOGO: 1
  DOTNET_CLI_TELEMETRY_OPTOUT: 1

jobs:
  version:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.set-version.outputs.version }}
    steps:
      - name: Determine version
        id: set-version
        run: |
          VERSION=${GITHUB_REF#refs/tags/}
          VERSION=${VERSION#v}
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

  package:
    needs: version
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            rid: linux-x64
            shell: bash
          - os: windows-latest
            rid: win-x64
            shell: pwsh
          - os: macos-latest
            rid: osx-arm64
            shell: bash
    env:
      DOTNET_NOLOGO: 1
      DOTNET_CLI_TELEMETRY_OPTOUT: 1
    steps:
      - uses: actions/checkout@v4
      - name: Setup .NET
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: '10.x'
      - name: Package kvtool (bash)
        if: matrix.os != 'windows-latest'
        shell: bash
        env:
          KVTOOL_VERSION: ${{ needs.version.outputs.version }}
          KVTOOL_RIDS: ${{ matrix.rid }}
        run: ./build/package.sh
      - name: Package kvtool (PowerShell)
        if: matrix.os == 'windows-latest'
        shell: pwsh
        env:
          KVTOOL_VERSION: ${{ needs.version.outputs.version }}
          KVTOOL_RIDS: ${{ matrix.rid }}
        run: .\build\package.ps1 -Version ${{ needs.version.outputs.version }}
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: kvtool-${{ matrix.rid }}
          path: dist/${{ needs.version.outputs.version }}

  publish:
    needs: [package, version]
    runs-on: ubuntu-latest
    steps:
      - name: Download linux package
        uses: actions/download-artifact@v4
        with:
          name: kvtool-linux-x64
          path: artifacts/linux
      - name: Download windows package
        uses: actions/download-artifact@v4
        with:
          name: kvtool-win-x64
          path: artifacts/windows
      - name: Download macOS package
        uses: actions/download-artifact@v4
        with:
          name: kvtool-osx-arm64
          path: artifacts/macos
      - name: Assemble release assets
        shell: bash
        run: |
          set -euo pipefail
          VERSION=${{ needs.version.outputs.version }}
          DIST_DIR="dist/$VERSION"
          rm -rf "$DIST_DIR"
          mkdir -p "$DIST_DIR"
          shopt -s nullglob
          for artifact in artifacts/*/kvtool-"$VERSION"-*.zip artifacts/*/kvtool-"$VERSION"-*.tar.gz; do
            cp "$artifact" "$DIST_DIR/"
          done
          cat artifacts/*/checksums.txt > "$DIST_DIR/checksums.txt"
      - name: Create GitHub release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          release_name: "kvtool ${{ needs.version.outputs.version }}"
          files: dist/${{ needs.version.outputs.version }}/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}